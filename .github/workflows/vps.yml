name: Create VPS (Minecraft + Playit + tmate + Backup + Password)

on:
  workflow_dispatch:
  repository_dispatch:
    types: [create-vps]

jobs:
  start-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.FILEBASE_ACCESS_KEY }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.FILEBASE_SECRET_KEY }}
      AWS_DEFAULT_REGION: us-east-1
      FILEBASE_BUCKET: ${{ secrets.FILEBASE_BUCKET }}
      GH_TOKEN: ${{ secrets.GH_TOKEN }}

    steps:
      - name: ‚¨áÔ∏è Checkout
        uses: actions/checkout@v3

      - name: üìÅ Prepare directories
        run: |
          mkdir -p links server backups ~/.config/playit_gg

      - name: üîë Set runner password
        run: |
          echo "runner:MySecurePass123!" | sudo chpasswd
          echo "‚úÖ Runner password set (user=runner)" > links/password.txt

      - name: üì• Install Dependencies + AWS CLI v2 + tmate
        run: |
          sudo apt update -y
          sudo apt install -y unzip zip curl wget screen openjdk-17-jdk tmate
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip -q awscliv2.zip
          sudo ./aws/install --update
          aws --version
          tmate -V

      - name: üíæ Restore server backup
        run: |
          if aws --endpoint-url=https://s3.filebase.com s3 ls "s3://$FILEBASE_BUCKET/server-backup.zip" >/dev/null 2>&1; then
            echo "‚¨áÔ∏è Restoring server-backup.zip ..."
            aws --endpoint-url=https://s3.filebase.com s3 cp "s3://$FILEBASE_BUCKET/server-backup.zip" server-backup.zip
            unzip -o server-backup.zip -d server
          else
            echo "‚ö†Ô∏è No previous server-backup.zip found, starting fresh."
          fi

      - name: üì• Download Paper 1.20.1 (if missing)
        run: |
          cd server
          if [ ! -f paper-1.20.1.jar ]; then
            echo "‚¨áÔ∏è Downloading Paper 1.20.1..."
            curl -L -o paper-1.20.1.jar "https://api.papermc.io/v2/projects/paper/versions/1.20.1/builds/106/downloads/paper-1.20.1-106.jar"
          fi
          echo "eula=true" > eula.txt

      - name: üöÄ Start Minecraft server
        run: |
          cd server
          screen -dmS mc bash -c 'java -Xms12G -Xmx12G -jar paper-1.20.1.jar nogui'
          sleep 10
          if screen -list | grep -q "\bmc\b"; then
            echo "‚úÖ Minecraft started in screen 'mc'"
            echo "Use: screen -r mc" > ../links/mc-server.txt
          else
            echo "‚ö†Ô∏è Failed to start Minecraft screen session"
            screen -ls || true

      - name: üöÄ Start Playit agent (persistent)
        run: |
          AGENT_BIN="./playit"
          if [ ! -f "$AGENT_BIN" ]; then
            curl -L -o "$AGENT_BIN" "https://github.com/playit-cloud/playit-agent/releases/latest/download/playit-linux-amd64"
            chmod +x "$AGENT_BIN"
          fi

          mkdir -p ~/.config/playit_gg
          if ! aws --endpoint-url=https://s3.filebase.com s3 cp "s3://$FILEBASE_BUCKET/playit.toml" ~/.config/playit_gg/playit.toml >/dev/null 2>&1; then
            echo "‚ö†Ô∏è No playit.toml in Filebase, will be generated on first run"
          fi

          nohup $AGENT_BIN --config ~/.config/playit_gg/playit.toml > playit.log 2>&1 &
          sleep 20
          tail -n 200 playit.log > links/playit.txt || echo "‚ö†Ô∏è No playit log" > links/playit.txt
          echo "‚úÖ Playit started (check links/playit.txt for tunnel info)"

      - name: üöÄ Start tmate session (SSH access)
        run: |
          tmate -S /tmp/tmate.sock new-session -d
          tmate -S /tmp/tmate.sock wait tmate-ready
          TMATE_SSH=$(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}')
          echo "$TMATE_SSH" | tee links/ssh.txt
          echo "‚úÖ tmate session started. SSH link saved to links/ssh.txt"
          aws --endpoint-url=https://s3.filebase.com s3 cp links/ssh.txt "s3://$FILEBASE_BUCKET/ssh.txt" || true

      - name: ‚è≥ Keep VPS alive (6 hours)
        run: |
          for i in $(seq 1 360); do
            echo "üü¢ Minute $i/360..."
            sleep 60 || break
          done

      - name: üíæ Stop server safely & Backup
        if: always()
        run: |
          if screen -list | grep -q "\bmc\b"; then
            echo "‚ö†Ô∏è Sending warnings to players..."
            screen -S mc -p 0 -X stuff "say ‚ö†Ô∏è Server will restart in 60 seconds!$(printf '\r')"
            sleep 50
            screen -S mc -p 0 -X stuff "say ‚ö†Ô∏è Server will restart in 10 seconds! Saving world...$(printf '\r')"
            sleep 10
            screen -S mc -p 0 -X stuff "stop$(printf '\r')"
            sleep 20
          fi

          if [ -d server ]; then
            cd server
            zip -r ../server-backup.zip ./*
            cd ..
            aws --endpoint-url=https://s3.filebase.com s3 cp server-backup.zip "s3://$FILEBASE_BUCKET/server-backup.zip"
            echo "‚úÖ Server backup uploaded"
          fi

          if [ -f ~/.config/playit_gg/playit.toml ]; then
            aws --endpoint-url=https://s3.filebase.com s3 cp ~/.config/playit_gg/playit.toml "s3://$FILEBASE_BUCKET/playit.toml"
            echo "‚úÖ playit.toml uploaded"
          fi

      - name: üîÅ Restart workflow automatically
        if: always()
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Content-Type: application/json" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d '{"event_type":"create-vps"}'
